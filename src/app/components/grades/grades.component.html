<div class="container" [formGroup]="gradesForm">
  <div class="header">
    <h1>Lançamento de Notas</h1>
  </div>

  <div class="filters">
    <div class="filter-item">
      <mat-form-field appearance="fill">
        <mat-label>Ano Letivo</mat-label>
        <mat-select formControlName="year">
          @for (year of years; track $index) {
            <mat-option [value]="year">{{ year }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <div class="filter-item">
      <mat-form-field appearance="fill">
        <mat-label>Turma</mat-label>
        <mat-select formControlName="class">
          @for (class of classes; track $index) {
            <mat-option [value]="class">{{ class }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <div class="filter-item">
      <mat-form-field appearance="fill">
        <mat-label>Matéria</mat-label>
        <mat-select formControlName="subject">
          @for (subject of subjects; track $index) {
            <mat-option [value]="subject">{{ subject }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <div class="filter-item">
      <mat-form-field appearance="fill">
        <mat-label>Bimestre</mat-label>
        <mat-select formControlName="bimester">
          @for (bimester of bimesters; track $index) {
            <mat-option [value]="bimester">{{ bimester }}º Bimestre</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="onFilterChange()">
        Atualizar Filtros
      </button>
    </div>
  </div>

  <div class="table-container">
    <table mat-table [dataSource]="filteredStudents" class="mat-elevation-z8">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Aluno</th>
        <td mat-cell *matCellDef="let student">{{ student.name }}</td>
      </ng-container>

      <ng-container matColumnDef="gradeP1">
        <th mat-header-cell *matHeaderCellDef>Prova P1</th>
        <td mat-cell *matCellDef="let student">
          <input matInput type="number" [formControlName]="'gradeP1_' + student.id" (input)="calculateAverage(student.id)" />
        </td>
      </ng-container>

      <ng-container matColumnDef="gradeP2">
        <th mat-header-cell *matHeaderCellDef>Prova P2</th>
        <td mat-cell *matCellDef="let student">
          <input matInput type="number" [formControlName]="'gradeP2_' + student.id" (input)="calculateAverage(student.id)" />
        </td>
      </ng-container>

      <ng-container matColumnDef="average">
        <th mat-header-cell *matHeaderCellDef>Média</th>
        <td mat-cell *matCellDef="let student">
          <input matInput type="text" [formControlName]="'average_' + student.id" readonly />
        </td>
      </ng-container>

      <ng-container matColumnDef="gradeRec">
        <th mat-header-cell *matHeaderCellDef>Recuperação</th>
        <td mat-cell *matCellDef="let student">
          <input matInput type="number" [formControlName]="'gradeRec_' + student.id" />
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['name', 'gradeP1', 'gradeP2', 'average', 'gradeRec']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['name', 'gradeP1', 'gradeP2', 'average', 'gradeRec'];"></tr>
    </table>
  </div>

  <div class="actions">
    <button
      mat-raised-button
      color="primary"
      [disabled]="gradesForm.invalid"
      (click)="saveGrades()"
    >
      Salvar Notas
    </button>
  </div>
</div>
